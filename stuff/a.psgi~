#!/usr/bin/perl

use strict;
use warnings;

use Plack::Request;
my $d = {};
my $app = sub {
    my $env = shift;
    my $req = Plack::Request->new($env);
    my $h = $req->headers;
    my $ua = $h->header('User-Agent');
    $d->{$ua}++;
    my $path_info = $env->{PATH_INFO};
    print "$$, path $path_info, ua $ua, d $d->{$ua}\n";
    if ($d->{$ua} < 5) {
        return [301, [Location => "http://localhost:5000/$path_info"], []];
    } else {
        return [200, [], []];
    }
};

return $app;
